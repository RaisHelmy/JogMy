@model JogMy.Features.Admin.ViewModels.EditTrackViewModel

@{
    ViewData["Title"] = "Edit Jogging Track";
}

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">Edit Jogging Track</h4>
            </div>
            <div class="card-body">
                <form asp-action="EditTrack" method="post" enctype="multipart/form-data">
                    <input asp-for="Id" type="hidden" />
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>
                    
                    <div class="mb-3">
                        <label asp-for="Name" class="form-label"></label>
                        <input asp-for="Name" class="form-control" placeholder="Enter track name" />
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Distance" class="form-label"></label>
                                <input asp-for="Distance" class="form-control" step="0.1" placeholder="e.g., 5.2" />
                                <span asp-validation-for="Distance" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Region" class="form-label"></label>
                                <select asp-for="Region" class="form-select">
                                    <option value="">Select Region</option>
                                    <option value="KL">Kuala Lumpur</option>
                                    <option value="Selangor">Selangor</option>
                                </select>
                                <span asp-validation-for="Region" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="Description" class="form-label"></label>
                        <textarea asp-for="Description" class="form-control" rows="3" placeholder="Optional description of the track"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <!-- Tooltip Customization Section -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-chat-square-text me-2"></i>Tooltip Customization
                            </h6>
                            <small class="text-muted">Customize how this track appears in map tooltips for joggers</small>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="CustomDifficulty" class="form-label"></label>
                                        <select asp-for="CustomDifficulty" class="form-select">
                                            <option value="">Auto-calculate from distance</option>
                                            <option value="Easy">Easy</option>
                                            <option value="Moderate">Moderate</option>
                                            <option value="Hard">Hard</option>
                                            <option value="Expert">Expert</option>
                                        </select>
                                        <span asp-validation-for="CustomDifficulty" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="SurfaceType" class="form-label"></label>
                                        <input asp-for="SurfaceType" class="form-control" placeholder="e.g., Paved, Trail, Mixed" />
                                        <span asp-validation-for="SurfaceType" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label asp-for="SpecialFeatures" class="form-label"></label>
                                <input asp-for="SpecialFeatures" class="form-control" placeholder="e.g., Scenic views, Shaded path, Hills" />
                                <span asp-validation-for="SpecialFeatures" class="text-danger"></span>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="BestTimeToJog" class="form-label"></label>
                                        <input asp-for="BestTimeToJog" class="form-control" placeholder="e.g., Early morning, Evening" />
                                        <span asp-validation-for="BestTimeToJog" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label asp-for="SafetyNotes" class="form-label"></label>
                                        <input asp-for="SafetyNotes" class="form-control" placeholder="e.g., Busy road nearby, Well monitored" />
                                        <span asp-validation-for="SafetyNotes" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <label class="form-label">Amenities Available</label>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input asp-for="HasParking" class="form-check-input" type="checkbox" />
                                                <label asp-for="HasParking" class="form-check-label"></label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input asp-for="HasWaterFountains" class="form-check-input" type="checkbox" />
                                                <label asp-for="HasWaterFountains" class="form-check-label"></label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input asp-for="HasRestrooms" class="form-check-input" type="checkbox" />
                                                <label asp-for="HasRestrooms" class="form-check-label"></label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input asp-for="IsWellLit" class="form-check-input" type="checkbox" />
                                                <label asp-for="IsWellLit" class="form-check-label"></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Track Media Section -->
                    @if (Model.ExistingMedia.Any())
                    {
                        <div class="card mt-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-images me-2"></i>Existing Photos & Videos
                                </h6>
                                <small class="text-muted">Current media files for this track</small>
                            </div>
                            <div class="card-body">
                                <div class="row g-3" id="existingMediaContainer">
                                    @foreach (var media in Model.ExistingMedia)
                                    {
                                        <div class="col-md-4 col-sm-6" id="media-@media.Id">
                                            <div class="card">
                                                <div class="card-body p-2">
                                                    @if (media.MediaType == JogMy.Models.MediaType.Video)
                                                    {
                                                        <video src="@media.FilePath" class="img-fluid rounded" style="max-height: 150px; width: 100%; object-fit: cover;" controls></video>
                                                    }
                                                    else
                                                    {
                                                        <img src="@media.FilePath" alt="Track Photo" class="img-fluid rounded" style="max-height: 150px; width: 100%; object-fit: cover;" />
                                                    }
                                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                                        <small class="text-info">@media.MediaType.ToString()</small>
                                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteTrackMedia(@media.Id)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Add New Track Media Section -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-plus-circle me-2"></i>Add New Photos & Videos
                            </h6>
                            <small class="text-muted">Upload additional photos or videos for this track</small>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label asp-for="MediaFiles" class="form-label"></label>
                                <input asp-for="MediaFiles" type="file" class="form-control" multiple accept="image/*,video/*" id="mediaUpload" onchange="previewTrackMedia(this)" />
                                <div class="form-text">You can upload multiple photos and videos. Supported formats: JPG, PNG, MP4, MOV</div>
                                <span asp-validation-for="MediaFiles" class="text-danger"></span>
                            </div>
                            
                            <!-- Media Preview Container -->
                            <div id="mediaPreviewContainer" class="row g-3" style="display: none;">
                                <div class="col-12">
                                    <h6 class="text-primary">Preview:</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="Coordinates" class="form-label"></label>
                        <textarea asp-for="Coordinates" class="form-control" rows="5" placeholder='Enter coordinates as JSON array'></textarea>
                        <div class="form-text">
                            Enter coordinates as a JSON array of [latitude, longitude] pairs.
                            <button type="button" class="btn btn-link btn-sm p-0" onclick="showCoordinateExample()">Show example</button>
                        </div>
                        <span asp-validation-for="Coordinates" class="text-danger"></span>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Update Track</button>
                        <a asp-action="Tracks" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Coordinate Format Help</h6>
            </div>
            <div class="card-body">
                <p class="small">Coordinates should be in JSON format:</p>
                <pre class="small bg-light p-2 rounded" id="coordinateExample" style="display: none;">
[
  [3.1319, 101.6841],
  [3.1320, 101.6842],
  [3.1321, 101.6843],
  [3.1322, 101.6844]
]</pre>
                <p class="small mt-2">Each coordinate pair represents:</p>
                <ul class="small">
                    <li><strong>First number:</strong> Latitude</li>
                    <li><strong>Second number:</strong> Longitude</li>
                </ul>
                <p class="small">You can use tools like Google Maps to find coordinates by right-clicking on locations.</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    <script>
        function showCoordinateExample() {
            const example = document.getElementById('coordinateExample');
            example.style.display = example.style.display === 'none' ? 'block' : 'none';
        }

        // Media preview functionality
        function previewTrackMedia(input) {
            const container = document.getElementById('mediaPreviewContainer');
            
            // Clear existing previews
            const existingPreviews = container.querySelectorAll('.media-preview');
            existingPreviews.forEach(preview => preview.remove());
            
            if (input.files && input.files.length > 0) {
                container.style.display = 'block';
                
                for (let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const isVideo = file.type.startsWith('video/');
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'col-md-4 col-sm-6 media-preview';
                        
                        previewDiv.innerHTML = `
                            <div class="card">
                                <div class="card-body p-2">
                                    ${isVideo 
                                        ? `<video src="${e.target.result}" class="img-fluid rounded" style="max-height: 150px; width: 100%; object-fit: cover;" controls></video>`
                                        : `<img src="${e.target.result}" alt="Preview" class="img-fluid rounded" style="max-height: 150px; width: 100%; object-fit: cover;" />`
                                    }
                                    <small class="text-muted d-block mt-1">${file.name}</small>
                                    <small class="text-info">${isVideo ? 'Video' : 'Image'} - ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(previewDiv);
                    };
                    
                    reader.readAsDataURL(file);
                }
            } else {
                container.style.display = 'none';
            }
        }

        // Delete existing media
        function deleteTrackMedia(mediaId) {
            if (confirm('Are you sure you want to delete this media file? This action cannot be undone.')) {
                fetch('/Admin/DeleteTrackMedia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify(mediaId)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('media-' + mediaId).remove();
                        
                        // Check if there are no more existing media items
                        const existingMediaContainer = document.getElementById('existingMediaContainer');
                        if (existingMediaContainer && existingMediaContainer.children.length === 0) {
                            // Hide the entire existing media section
                            existingMediaContainer.closest('.card').style.display = 'none';
                        }
                    } else {
                        alert('Error deleting media: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting media. Please try again.');
                });
            }
        }
    </script>
}